<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户注册</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <!-- Bootstrap core CSS -->
    <link href="../layui/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

<form class="layui-form" id="registerForm" action="" method="post">
    <div class="layui-form-item">
        <label class="layui-form-label">手机号</label>
        <div class="layui-input-inline">
            <input type="text" name="telphone" id="telPhone" required lay-verify="required" placeholder="请输手机号"
                   autocomplete="off" class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux "></div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline">
            <input type="text" name="otpCode" id="otpCode" required lay-verify="required" placeholder="请输入验证码"
                   autocomplete="off" class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux "><input id="code-btn" class="btn btn-sm btn-success " type="button"
                                                           value="获取验证码"/></div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">昵称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" id="name" required lay-verify="required" placeholder="请输入昵称"
                   autocomplete="off" class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux"></div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-inline">
            <input type="password" name="encrptPassword" id="password" required lay-verify="required"
                   placeholder="请输入密码" autocomplete="off" class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux"></div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">性别</label>
        <div class="layui-input-block">
            <input type="radio" name="gender" value="1" title="男">
            <input type="radio" name="gender" value="2" title="女" checked>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">年龄</label>
        <div class="layui-input-inline">
            <input type="text" name="age" required lay-verify="required" placeholder="请输入年龄" autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux"></div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" type="button" id="register">立即注册</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>

<script src="../layui/layui.all.js"></script>
<script src="../layui/jquery-3.4.1.js"></script>


<script>

    ;!function () {
        var layer = layui.layer
            , form = layui.form;

        // layer.msg('Hello World');
    }();

    $(function () {

        var InterValObj; //timer变量，控制时间
        var count = 60; //间隔函数，1秒执行
        var curCount;//当前剩余秒数

        $("#code-btn").click(function () {

            var telPhone = $("#telPhone").val();
            if (telPhone == "") {
                layer.msg("手机号不能为空！")
                return;
            }
            curCount = count;
            //设置button效果，开始计时
            $("#code-btn").attr("disabled", "true");
            // $("#span").text( curCount + "秒内重试");
            InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
            //向后台发送处理数据

            $.ajax({
                url: "http://localhost:8080/miaosha/user/getotp",
                type: "POST",
                xhrFields: {withCredentials: true},	//前端适配：允许session跨域
                crossDomain: true,
                data: {"telphone": telPhone},
                success: function (data) {
                    if (data.status == "success") {
                        layer.msg("验证码已发送到您的手机上，请注意查收")
                    } else {
                        alert("发送失败：" + data.data.errMsg)
                    }
                },
                error: function (data) {
                    alert("系统发生错误：" + data.data.errMsg)
                }
            });
        })

        //timer处理函数
        function SetRemainTime() {
            if (curCount == 0) {
                window.clearInterval(InterValObj);//停止计时器
                $("#code-btn").removeAttr("disabled");//启用按钮
                $("#code-btn").val("重新发送验证码");
            } else {
                curCount--;
                $("#code-btn").val("请在" + curCount + "秒内重试");
            }
        }


        $("#register").click(function () {
            if (validated_form()) {
                $.ajax({
                    url: "http://localhost:8080/miaosha/user/register",
                    type: "POST",
                    xhrFields: {withCredentials: true},	//前端适配：允许session跨域
                    crossDomain: true,
                    data: $("form").serialize(),
                    success: function (res) {
                        if (res.status == "success") {
                            alert("注册成功")
                            window.location.href = "login.html"
                        } else {
                            alert("注册失败：" + res.data.errMsg)
                        }
                    },
                    error: function (res) {
                        alert("注册失败,系统内部错误：" + res.data.errMsg)
                    }

                })
            }

        })

        function validated_form() {
            var otpCode = $("#otpCode").val();
            var age = $("#age").val();
            var password = $("#password").val();
            var name = $("#name").val();

            if (otpCode == "") {
                layer.msg("验证码不能为空")
                return false;
            }
            if (name == "") {
                layer.msg("昵称不能为空")
                return false;
            }
            if (password == "") {
                layer.msg("密码不能为空")
                return false;
            }
            if (age == "") {
                layer.msg("年龄不能为空")
                return false;
            }
            if (password == "") {
                layer.msg("密码不能为空")
                return false;
            }

            return true;
        }

    })
</script>
</body>
</html>